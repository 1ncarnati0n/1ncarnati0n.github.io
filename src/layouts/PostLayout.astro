---
import BaseLayout from "./BaseLayout.astro";
import Breadcrumbs from "../components/Breadcrumbs.astro";
import TagList from "../components/TagList.astro";
import TableOfContents from "../components/TableOfContents.astro";
import { formatDate, getReadingTime, getPostCategory, deriveTitle } from "../lib/content-utils";

interface Props {
  title?: string;
  slug: string;
  date?: Date;
  description?: string;
  tags?: string[];
  headings: { depth: number; slug: string; text: string }[];
  rawContent: string;
}

const { title, slug, date, description, tags = [], headings, rawContent } = Astro.props;
const displayTitle = deriveTitle(slug, title);
const category = getPostCategory(slug);
const readTime = getReadingTime(rawContent);
---

<BaseLayout title={displayTitle} description={description}>
  <article class="post-page container">
    <div class="post-layout">
      <div class="post-main">
        <Breadcrumbs
          items={[
            { label: "Blog", href: "/posts/" },
            { label: category, href: `/posts/#${category}` },
            { label: displayTitle },
          ]}
        />

        <header class="post-header">
          <h1>{displayTitle}</h1>
          <div class="post-meta">
            {date && <time datetime={date.toISOString()}>{formatDate(date)}</time>}
            <span class="meta-sep">&middot;</span>
            <span>{readTime} 읽기</span>
            <span class="meta-sep">&middot;</span>
            <span class="meta-category">{category}</span>
          </div>
          <TagList tags={tags} />
        </header>

        <div class="prose">
          <slot />
        </div>
      </div>

      <aside class="post-sidebar">
        <TableOfContents headings={headings} />
      </aside>
    </div>
  </article>
</BaseLayout>

<style>
  .post-page {
    padding-top: var(--spacing-xl);
    padding-bottom: var(--spacing-2xl);
  }
  .post-layout {
    display: grid;
    grid-template-columns: 1fr var(--sidebar-width);
    gap: var(--spacing-2xl);
    align-items: start;
  }
  .post-header {
    margin-bottom: var(--spacing-xl);
  }
  .post-header h1 {
    font-size: 2rem;
    margin-bottom: var(--spacing-sm);
    line-height: 1.3;
  }
  .post-meta {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 0.85rem;
    color: var(--gray);
    font-family: var(--font-header);
    margin-bottom: var(--spacing-md);
  }
  .meta-sep {
    opacity: 0.3;
  }
  .meta-category {
    text-transform: capitalize;
  }
  .post-sidebar {
    display: block;
  }

  @media (max-width: 900px) {
    .post-layout {
      grid-template-columns: 1fr;
    }
    .post-sidebar {
      display: none;
    }
  }
</style>
